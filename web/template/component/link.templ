package component

import (
	"github.com/qxuken/short/internal/utils"
	"github.com/qxuken/short/internal/db"
)

templ RedirectUrlInput(err string) {
	<div class="input-container" hx-target="this" hx-swap="outerHTML">
		<input
			id="redirect_url"
			name="redirect_url"
			type="text"
			placeholder="Past your long link here"
			hx-post="/f/redirect_url"
			hx-preserve
		/>
		if err != "" {
			<div class="input-error">
				@CrossIcon(22)
				<span>{ err }</span>
			</div>
		}
	</div>
}

templ ShortUrlInput(err string) {
	<div class="input-container" hx-target="this" hx-swap="outerHTML">
		<input type="hidden" name="short_type" value="custom"/>
		<input
			id="short_url"
			name="short_url"
			type="text"
			placeholder="Enter handle for short url"
			hx-post="/f/short_url"
			hx-preserve
		/>
		if err != "" {
			<div class="input-error">
				@CrossIcon(22)
				<span>{ err }</span>
			</div>
		}
	</div>
}

templ LinkFormActions(shortType string) {
	<div class="form-actions">
		<button type="submit">SHORT IT</button>
		<span>OR</span>
		if shortType == "custom" {
			<button hx-post="/f/generated" hx-target="#create-link">RETURN TO AUTO GENERATED</button>
		} else {
			<button hx-post="/f/custom" hx-target="#create-link">USE CUSTOM SHORT</button>
		}
	</div>
}

templ CreateLink(baseUrl, shortType, urlErr, shortErr string) {
	<form id="create-link" class="shortiq-form" hx-post="/" hx-swap="outerHTML">
		@RedirectUrlInput(urlErr)
		if shortType == "custom" {
			@ShortUrlInput(shortErr)
		}
		@LinkFormActions(shortType)
	</form>
}

script Copy(url templ.SafeURL) {
	navigator.permissions.query({ name: "clipboard-write" }).then((result) => {
		if (result.state === "granted" || result.state === "prompt") {
			navigator.clipboard.writeText(url)
		}
	})
}

templ SuccessfullyCreated(short templ.SafeURL) {
	<div hx-target="this" hx-swap="outerHTML">
		<h2>Your link is ready</h2>
		<div>
			<a href={ short } target="_blank">{ string(short) }</a>
			<button onclick={ Copy(short) }>Copy to clipboard</button>
		</div>
		<div><a href="/">Create another</a></div>
	</div>
}

templ LinkStats(short templ.SafeURL, data []db.AnalyticsItem) {
	<div hx-target="this" hx-swap="outerHTML">
		<div>
			<a href={ short } target="_blank">{ string(short) }</a>
			<button onclick={ Copy(short) }>Copy to clipboard</button>
		</div>
		<div><a href="/">Create another</a></div>
		<ul>
			for _, v := range data {
				<li>{ v.Country }, { v.Referer }, { utils.DateFormat("", v.Ts) }</li>
			}
		</ul>
	</div>
}
